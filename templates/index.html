<!-- HTML + bootstrap -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人代辦系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .col-list { min-height: 200px; }
    .todo-card { margin-bottom: 0.75rem; }
    .due-soon { font-weight: 600; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>個人代辦系統</h2>
    <div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#todoModal" id="btnNew">新增任務</button>
    </div>
  </div>

  <!-- 搜尋 + 統計 -->
  <div class="row mb-3 g-2 align-items-center">
    <div class="col-md-6">
      <div class="input-group">
        <input id="searchInput" type="text" class="form-control" placeholder="搜尋標題或內容...">
        <button id="btnSearch" class="btn btn-outline-secondary">搜尋</button>
        <button id="btnReset" class="btn btn-outline-secondary">還原</button>
      </div>
    </div>
    <div class="col-md-6 text-end">
      <span id="stats" class="me-2">載入統計...</span>
    </div>
  </div>

  <!-- 三欄：ToDo / On-going / Done -->
  <div class="row">
    <div class="col-md-4">
      <h5>ToDo</h5>
      <div id="col-todo" class="col-list"></div>
    </div>
    <div class="col-md-4">
      <h5>On-going</h5>
      <div id="col-ongoing" class="col-list"></div>
    </div>
    <div class="col-md-4">
      <h5>Done</h5>
      <div id="col-done" class="col-list"></div>
    </div>
  </div>
</div>

<!-- Modal for Add/Edit -->
<div class="modal fade" id="todoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="todoForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">新增任務</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="todoId">
        <div class="mb-3">
          <label class="form-label">標題</label>
          <input id="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">內容</label>
          <textarea id="description" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">狀態</label>
          <select id="status" class="form-select">
            <option value="ToDo">ToDo</option>
            <option value="On-going">On-going</option>
            <option value="Done">Done</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">到期日</label>
          <input id="due_date" type="date" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">儲存</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = '/';
const modal = new bootstrap.Modal(document.getElementById('todoModal'), {});
const form = document.getElementById('todoForm');
const searchInput = document.getElementById('searchInput');
const btnSearch = document.getElementById('btnSearch');
const btnReset = document.getElementById('btnReset');
const statsEl = document.getElementById('stats');

document.getElementById('btnNew').addEventListener('click', () => {
  document.getElementById('modalTitle').innerText = '新增任務';
  document.getElementById('todoId').value = '';
  form.reset();
  document.getElementById('status').value = 'ToDo';
});

btnSearch.addEventListener('click', () => loadTodos(searchInput.value.trim()));
btnReset.addEventListener('click', () => {
  searchInput.value = '';
  loadTodos();
});

async function loadTodos(q='') {
  try {
    const url = q ? `/todos?q=${encodeURIComponent(q)}` : '/todos';
    const res = await fetch(url);
    const todos = await res.json();
    renderLists(todos);
    loadStats();
  } catch (err) {
    console.error(err);
  }
}

function renderLists(todos) {
  const colTodo = document.getElementById('col-todo');
  const colOngoing = document.getElementById('col-ongoing');
  const colDone = document.getElementById('col-done');
  colTodo.innerHTML = ''; colOngoing.innerHTML = ''; colDone.innerHTML = '';

  // sort by due_date asc (nulls last)
  todos.sort((a,b) => {
    if (!a.due_date && !b.due_date) return 0;
    if (!a.due_date) return 1;
    if (!b.due_date) return -1;
    return new Date(a.due_date) - new Date(b.due_date);
  });

  for (const t of todos) {
    const card = document.createElement('div');
    card.className = 'card todo-card';
    const dueText = t.due_date ? (`到期: ${t.due_date}`) : '無到期日';
    const bodyHtml = `
      <div class="card-body p-2">
        <div class="d-flex justify-content-between">
          <div><strong>${escapeHtml(t.title)}</strong></div>
          <div>
            <select class="form-select form-select-sm status-select" data-id="${t.id}" style="width:120px;display:inline-block">
              <option value="ToDo">ToDo</option>
              <option value="On-going">On-going</option>
              <option value="Done">Done</option>
            </select>
          </div>
        </div>
        <div class="small text-muted">${escapeHtml(t.description || '')}</div>
        <div class="small text-end mt-1">${dueText}</div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${t.id}">編輯</button>
          <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${t.id}">刪除</button>
        </div>
      </div>
    `;
    card.innerHTML = bodyHtml;

    // set selected status
    const sel = card.querySelector('.status-select');
    sel.value = t.status || 'ToDo';
    sel.addEventListener('change', async (e) => {
      await updateTodo(t.id, {status: e.target.value});
      loadTodos(searchInput.value.trim());
    });

    card.querySelector('.btn-edit').addEventListener('click', () => openEditModal(t));
    card.querySelector('.btn-delete').addEventListener('click', async () => {
      if (confirm('確定要刪除嗎？')) {
        await deleteTodo(t.id);
        loadTodos(searchInput.value.trim());
      }
    });

    if (t.status === 'ToDo') colTodo.appendChild(card);
    else if (t.status === 'On-going') colOngoing.appendChild(card);
    else colDone.appendChild(card);
  }
}

function openEditModal(t) {
  document.getElementById('modalTitle').innerText = '編輯任務';
  document.getElementById('todoId').value = t.id;
  document.getElementById('title').value = t.title;
  document.getElementById('description').value = t.description || '';
  document.getElementById('status').value = t.status || 'ToDo';
  document.getElementById('due_date').value = t.due_date || '';
  modal.show();
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('todoId').value;
  const payload = {
    title: document.getElementById('title').value.trim(),
    description: document.getElementById('description').value.trim(),
    status: document.getElementById('status').value,
    due_date: document.getElementById('due_date').value || null
  };
  try {
    if (id) {
      await updateTodo(id, payload);
    } else {
      await createTodo(payload);
    }
    modal.hide();
    loadTodos(searchInput.value.trim());
  } catch (err) {
    alert('儲存失敗，請檢查資料。');
    console.error(err);
  }
});

// API helpers
async function createTodo(data) {
  const res = await fetch('/todos', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  if (!res.ok) throw new Error('create failed');
  return res.json();
}

async function updateTodo(id, data) {
  const res = await fetch(`/todos/${id}`, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  if (!res.ok) throw new Error('update failed');
  return res.json();
}

async function deleteTodo(id) {
  const res = await fetch(`/todos/${id}`, { method: 'DELETE' });
  if (!res.ok) throw new Error('delete failed');
  return res.json();
}

async function loadStats() {
  try {
    const res = await fetch('/stats');
    const s = await res.json();
    statsEl.innerText = `總數 ${s.total} · ToDo ${s.todo} · On-going ${s.ongoing} · Done ${s.done}`;
  } catch (err) {
    statsEl.innerText = '統計載入錯誤';
  }
}

// small helper
function escapeHtml(text) {
  if (!text) return '';
  return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// 初始載入
loadTodos();
</script>
</body>
</html>
